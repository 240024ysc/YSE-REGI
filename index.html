<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>M√°y Thanh To√°n</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        input[type="text"] {
            width: 200px;
        }

        #total {
            font-size: 20px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h2>YSE REGI</h2>

    <input type="text" id="product_code" placeholder="„Éê„Éº„Ç≥„Éº„ÉâÂÖ•Âäõ">
    <button onclick="addProduct()">ËøΩÂä†</button>

    <table id="cart_table">
        <thead>
            <tr>
                <th>„Éê„Éº„Ç≥„Éº„Éâ</th>
                <th>ÂïÜÂìÅÂêç</th>
                <th>ÈáëÈ°ç</th>
            </tr>
        </thead>
        <tbody></tbody>
        <div id="invoice"
            style="margin-top:20px; border:1px solid #ccc; padding:10px; width:300px; float:right; display:none;">
            <h3>ÊòéÁ¥∞Êõ∏</h3>
            <div id="invoice_items"></div>
            <div id="invoice_total" style="margin-top:10px; font-weight:bold;"></div>
            <button onclick="goBack()" style="margin-top:10px;">üîô</button>
        </div>
        <div id="sales_report_overlay" style="
            display:none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            justify-content: center;
            align-items: center;
        ">
            <div style="
                background: #fff;
                border-radius: 10px;
                padding: 20px;
                width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.2);
            ">
                <h2 style="text-align:center;">üìä ‰ªäÊó•„ÅÆÂ£≤„Çä‰∏ä„Åí</h2>
                <div id="sales_table" style="margin-top: 10px;"></div>
                <div id="sales_total" style="margin-top: 20px; font-weight: bold; text-align:right;"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeSales()"
                        style="padding: 10px 20px; border:none; background:#2196F3; color:white; border-radius:5px;">üîô</button>
                </div>
            </div>
        </div>



    </table>

    <div id="total">ÂêàË®à: 0 ÂÜÜ</div>
    <button onclick="checkout()">Á¢∫Ë™ç</button>
    <button onclick="toggleTax()">Á®éËæº</button>
    <button onclick="showDailySales()">Â£≤‰∏ä</button>


    <script>
        let cart = [];

        function addProduct() {
            const code = document.getElementById('product_code').value;
            fetch(`get_product.php?code=${code}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        cart.push(data.product);
                        renderCart();
                    } else {
                        alert('ÂïÜÂìÅ„ÇíË¶ã„Å§„Åë„Å™„ÅÑ!');
                    }
                });
            document.getElementById('product_code').value = '';
        }
        let includeTax = false;

        function toggleTax() {
            includeTax = !includeTax;
            renderCart();
        }

        function renderCart() {
            const tbody = document.querySelector('#cart_table tbody');
            tbody.innerHTML = '';
            let total = 0;
            cart.forEach(p => {
                total += parseFloat(p.price);
                tbody.innerHTML += `<tr>
                    <td>${p.code}</td>
                    <td>${p.name}</td>
                   <td>${parseFloat(p.price).toLocaleString()} ÂÜÜ</td>
                </tr>`;
            });
            let totalDisplay = total;
            if (includeTax) {
                totalDisplay *= 1.1; // Thu·∫ø 10%
            }

            document.getElementById('total').innerText =
                'ÂêàË®à: ' + totalDisplay.toLocaleString() + ' ÂÜÜ' + (includeTax ? ' (Á®éËæº)' : '');

        }

        function checkout() {
            if (cart.length === 0) {
                alert("Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o!");
                return;
            }

            fetch('checkout.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cart })
            }).then(res => res.text())
                .then(msg => {
                    alert(msg);

                    // Hi·ªÉn th·ªã h√≥a ƒë∆°n
                    const invoiceBox = document.getElementById('invoice');
                    const itemsBox = document.getElementById('invoice_items');
                    const totalBox = document.getElementById('invoice_total');

                    let html = "<ul>";
                    let total = 0;
                    cart.forEach(p => {
                        total += parseFloat(p.price);
                        html += `<li>${p.name}: ${parseFloat(p.price).toLocaleString()} ÂÜÜ</li>`;
                    });
                    html += "</ul>";

                    let totalWithTax = includeTax ? total * 1.1 : total;

                    itemsBox.innerHTML = html;
                    totalBox.innerText = "ÂêàË®à: " + totalWithTax.toLocaleString() + " ÂÜÜ" + (includeTax ? "" : "");

                    invoiceBox.style.display = 'block';

                    // Reset gi·ªè h√†ng
                    cart = [];
                    renderCart();
                });
        }
        function goBack() {
            document.getElementById('invoice').style.display = 'none';
            cart = [];
            renderCart();
        }
        function showDailySales() {
            fetch("sales_summary.php")
                .then(res => res.json())
                .then(data => {
                    let html = "";
                    const sortedDates = Object.keys(data).sort().reverse(); // ng√†y m·ªõi tr∆∞·ªõc

                    sortedDates.forEach(date => {
                        html += `<h3 style="margin-top:20px;">üìÖ ${date}</h3>`;
                        html += "<table style='width:100%; border-collapse: collapse;'>"
                            + "<tr style='background:#f0f0f0;'>"
                            + "<th style='padding:8px; border-bottom:1px solid #ccc;'>Th·ªùi gian</th>"
                            + "<th style='padding:8px; border-bottom:1px solid #ccc;'>M√£ giao d·ªãch</th>"
                            + "<th style='padding:8px; border-bottom:1px solid #ccc;'>T·ªïng ti·ªÅn</th>"
                            + "</tr>";

                        data[date].transactions.forEach(tx => {
                            html += `<tr>
                        <td style='padding:8px; border-bottom:1px solid #eee;'>${tx.created_at}</td>
                        <td style='padding:8px; border-bottom:1px solid #eee;'>#${tx.id}</td>
                        <td style='padding:8px; border-bottom:1px solid #eee;'>${parseFloat(tx.total).toLocaleString()} VND</td>
                    </tr>`;
                        });

                        html += `<tr style="font-weight:bold;"><td colspan="2">T·ªïng ng√†y ${date}</td>
                         <td>${parseFloat(data[date].total).toLocaleString()} VND</td></tr>`;

                        html += "</table>";
                    });

                    document.getElementById("sales_table").innerHTML = html;
                    document.getElementById("sales_total").innerHTML = ""; // kh√¥ng c·∫ßn t·ªïng t·∫•t c·∫£ n·ªØa
                    document.getElementById("sales_report_overlay").style.display = "flex";
                });
        }

        }

        function closeSales() {
            document.getElementById("sales_report_overlay").style.display = "none";
        }

    </script>
</body>

</html>